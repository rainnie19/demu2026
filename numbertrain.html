<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Hand Number Trainer + Recognizer (0–9)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background: #0b1220; }
  </style>
</head>
<body class="text-slate-100">
  <div class="max-w-6xl mx-auto p-4">
    <header class="flex items-center justify-between mb-4">
      <h1 class="text-2xl md:text-3xl font-bold">Hand Number Trainer + Recognizer <span class="text-slate-400 text-base">(MediaPipe Hands • No TensorFlow)</span></h1>
      <div class="flex gap-2">
        <button id="btnExport" class="px-3 py-2 rounded-2xl bg-indigo-600 hover:bg-indigo-500 shadow">Export Dataset</button>
        <label class="px-3 py-2 rounded-2xl bg-slate-700 hover:bg-slate-600 shadow cursor-pointer">
          Import Dataset<input id="fileImport" type="file" accept="application/json" class="hidden" />
        </label>
        <button id="btnClear" class="px-3 py-2 rounded-2xl bg-rose-600 hover:bg-rose-500 shadow">Clear Dataset</button>
      </div>
    </header>

    <section class="grid md:grid-cols-2 gap-4">
      <!-- Left: Camera -->
      <div class="bg-slate-900/60 rounded-2xl p-3 shadow-md">
        <div class="relative rounded-xl overflow-hidden">
          <video id="video" playsinline class="w-full rounded-xl"></video>
          <canvas id="canvas" class="absolute inset-0 w-full h-full"></canvas>
        </div>
        <div class="mt-3 flex flex-wrap items-center gap-2">
          <label class="flex items-center gap-2 bg-slate-800 rounded-xl px-3 py-2">
            <input id="chkDraw" type="checkbox" class="accent-indigo-500" checked />
            <span class="text-sm">Show landmarks</span>
          </label>
          <label class="flex items-center gap-2 bg-slate-800 rounded-xl px-3 py-2">
            <input id="chkMirror" type="checkbox" class="accent-indigo-500" checked />
            <span class="text-sm">Mirror video</span>
          </label>
          <label class="flex items-center gap-2 bg-slate-800 rounded-xl px-3 py-2">
            <input id="chkAuto" type="checkbox" class="accent-indigo-500" />
            <span class="text-sm">Auto-capture</span>
          </label>
          <div class="flex items-center gap-2 bg-slate-800 rounded-xl px-3 py-2">
            <span class="text-sm">Interval</span>
            <input id="numAutoMs" type="number" min="100" step="50" value="400" class="w-20 bg-slate-900 rounded px-2 py-1" />
            <span class="text-sm">ms</span>
          </div>
          <button id="btnCapture" class="px-3 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-500">Capture Sample</button>
        </div>
      </div>

      <!-- Right: Controls / Output -->
      <div class="space-y-4">
        <div class="bg-slate-900/60 rounded-2xl p-4 shadow-md">
          <h2 class="font-semibold mb-2">1) Choose Label</h2>
          <div id="labelGrid" class="grid grid-cols-5 gap-2"></div>
          <div class="mt-3 flex items-center gap-3">
            <label class="flex items-center gap-2 bg-slate-800 rounded-xl px-3 py-2">
              <span class="text-sm">Custom:</span>
              <input id="txtCustom" type="text" maxlength="10" placeholder="e.g. ThumbsUp" class="bg-slate-900 rounded px-2 py-1 w-32" />
            </label>
            <button id="btnUseCustom" class="px-3 py-2 rounded-xl bg-sky-600 hover:bg-sky-500">Use</button>
            <div class="text-sm text-slate-400">Current label: <span id="currentLabel" class="font-semibold text-slate-200">0</span></div>
          </div>
        </div>

        <div class="bg-slate-900/60 rounded-2xl p-4 shadow-md">
          <h2 class="font-semibold mb-2">2) Predict</h2>
          <div class="flex items-center gap-3 mb-3">
            <label class="flex items-center gap-2 bg-slate-800 rounded-xl px-3 py-2">
              <input id="chkPredict" type="checkbox" class="accent-indigo-500" checked />
              <span class="text-sm">Enable prediction</span>
            </label>
            <div class="text-sm text-slate-400">Top: <span id="predLabel" class="font-semibold text-slate-200">—</span> (<span id="predConf">0.00</span>)</div>
          </div>
          <div class="text-sm text-slate-400">Samples: <span id="countSamples" class="text-slate-200 font-semibold">0</span> • Labels: <span id="countLabels" class="text-slate-200 font-semibold">0</span></div>
        </div>
      </div>
    </section>

    <footer class="mt-6 text-xs text-slate-500">Dataset saved to <span class="font-semibold">localStorage</span>. Use Export/Import to back up or share.</footer>
  </div>

  <!-- MediaPipe Hands + Utils -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const chkDraw = document.getElementById('chkDraw');
    const chkMirror = document.getElementById('chkMirror');
    const chkAuto = document.getElementById('chkAuto');
    const numAutoMs = document.getElementById('numAutoMs');
    const btnCapture = document.getElementById('btnCapture');
    const labelGrid = document.getElementById('labelGrid');
    const txtCustom = document.getElementById('txtCustom');
    const btnUseCustom = document.getElementById('btnUseCustom');
    const currentLabelEl = document.getElementById('currentLabel');
    const chkPredict = document.getElementById('chkPredict');
    const predLabelEl = document.getElementById('predLabel');
    const predConfEl = document.getElementById('predConf');
    const countSamplesEl = document.getElementById('countSamples');
    const countLabelsEl = document.getElementById('countLabels');
    const btnExport = document.getElementById('btnExport');
    const btnClear = document.getElementById('btnClear');
    const fileImport = document.getElementById('fileImport');

    const DATA_KEY = 'hand_number_dataset';
    let dataset = loadDataset();
    let currentLabel = '0';

    function loadDataset() {
      try {
        const raw = localStorage.getItem(DATA_KEY);
        return raw ? JSON.parse(raw) : {};
      } catch (e) { return {}; }
    }
    function saveDataset() {
      localStorage.setItem(DATA_KEY, JSON.stringify(dataset));
      refreshCounts();
    }
    function refreshCounts() {
      const labels = Object.keys(dataset);
      countLabelsEl.textContent = labels.length;
      let samples = 0; labels.forEach(l => samples += dataset[l].length || 0);
      countSamplesEl.textContent = samples;
    }

    // === Build Label Grid (0–9)
    (function(){
      for(let n=0;n<=9;n++){
        const b = document.createElement('button');
        b.textContent = n;
        b.className = 'py-2 rounded-xl bg-slate-800 hover:bg-slate-700';
        b.addEventListener('click',()=>setCurrentLabel(String(n)));
        labelGrid.appendChild(b);
      }
      labelGrid.style.gridTemplateColumns = 'repeat(5, minmax(0, 1fr))';
    })();
    function setCurrentLabel(l){ currentLabel=l; currentLabelEl.textContent=l; }

    btnUseCustom.addEventListener('click',()=>{
      const v=txtCustom.value.trim();
      if(!v) return;
      setCurrentLabel(v);
      txtCustom.value='';
    });

    // === MediaPipe Hands
    const hands = new Hands({locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`});
    hands.setOptions({
      maxNumHands:1,
      modelComplexity:1,
      minDetectionConfidence:0.6,
      minTrackingConfidence:0.6
    });
    hands.onResults(onResults);

    const cam = new Camera(video,{
      onFrame:async()=>{await hands.send({image:video});},
      width:640,height:480
    });

    async function startCamera(){
      try{
        const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'user',width:640,height:480},audio:false});
        video.srcObject=stream; await video.play();
      }catch(err){alert('Camera permission required');}
      cam.start();
    }

    // === Feature extraction
    function extractFeatures(landmarks,w,h){
      const pts=landmarks.map(p=>({x:p.x*w,y:p.y*h,z:(p.z||0)*w}));
      const origin=pts[0];
      const rel=pts.map(p=>({x:p.x-origin.x,y:p.y-origin.y,z:p.z-origin.z}));
      let maxDist=1e-6;
      for(const p of rel){ const d=Math.hypot(p.x,p.y,p.z); if(d>maxDist)maxDist=d; }
      const norm=rel.map(p=>({x:p.x/maxDist,y:p.y/maxDist,z:p.z/maxDist}));
      const feat=[]; norm.forEach(p=>feat.push(p.x,p.y,p.z));
      return feat;
    }

    // === Classifier (Nearest Centroid)
    function centroid(vectors){
      const c=new Array(vectors[0].length).fill(0);
      vectors.forEach(v=>{for(let i=0;i<c.length;i++)c[i]+=v[i];});
      for(let i=0;i<c.length;i++)c[i]/=vectors.length;
      return c;
    }
    function dot(a,b){let s=0;for(let i=0;i<a.length;i++)s+=a[i]*b[i];return s;}
    function norm(a){return Math.sqrt(dot(a,a));}
    function cosine(a,b){const n=(norm(a)*norm(b))||1e-6;return dot(a,b)/n;}
    function predict(feat){
      const labels=Object.keys(dataset);
      if(!labels.length)return{label:'—',conf:0};
      let best={label:'—',conf:-Infinity};
      for(const l of labels){
        const vecs=dataset[l]; if(!vecs.length)continue;
        const c=centroid(vecs);
        const sim=cosine(feat,c);
        if(sim>best.conf)best={label:l,conf:sim};
      }
      return best.conf===-Infinity?{label:'—',conf:0}:best;
    }

    // === Drawing
    const HAND_CONNECTIONS = window.HAND_CONNECTIONS;
    function drawLandmarksAndConnections(landmarks,w,h){
      if(HAND_CONNECTIONS)window.drawConnectors(ctx,landmarks,HAND_CONNECTIONS,{lineWidth:3});
      window.drawLandmarks(ctx,landmarks,{radius:3});
    }

    // === Capture & Predict
    let lastCapture=0;
    function onResults(results){
      const {image,multiHandLandmarks}=results;
      canvas.width=image.width; canvas.height=image.height;
      ctx.save();
      if(chkMirror.checked){ctx.translate(canvas.width,0);ctx.scale(-1,1);}
      ctx.drawImage(image,0,0,canvas.width,canvas.height);
      let feat=null;
      if(multiHandLandmarks&&multiHandLandmarks.length){
        const lm=multiHandLandmarks[0];
        if(chkDraw.checked)drawLandmarksAndConnections(lm,canvas.width,canvas.height);
        feat=extractFeatures(lm,canvas.width,canvas.height);

        const now=performance.now();
        if(chkAuto.checked && now-lastCapture>Number(numAutoMs.value||400)){
          captureSample(feat);
          lastCapture=now;
        }

        if(chkPredict.checked){
          const out=predict(feat);
          predLabelEl.textContent=out.label;
          predConfEl.textContent=out.conf.toFixed(2);
        }else{
          predLabelEl.textContent='—';
          predConfEl.textContent='0.00';
        }
      }else{
        predLabelEl.textContent='—';
        predConfEl.textContent='0.00';
      }
      ctx.restore();
    }

    function captureSample(feat){
      if(!feat)return;
      if(!dataset[currentLabel])dataset[currentLabel]=[];
      dataset[currentLabel].push(feat);
      saveDataset();
    }
    btnCapture.addEventListener('click',()=>{lastCapture=0;});

    // === Export / Import / Clear
    btnExport.addEventListener('click',()=>{
      const blob=new Blob([JSON.stringify(dataset)],{type:'application/json'});
      const a=document.createElement('a');
      a.href=URL.createObjectURL(blob);
      a.download='hand_number_dataset.json';
      a.click(); URL.revokeObjectURL(a.href);
    });
    btnClear.addEventListener('click',()=>{
      if(!confirm('Clear dataset?'))return;
      dataset={}; saveDataset();
    });
    fileImport.addEventListener('change',async e=>{
      const f=e.target.files[0]; if(!f)return;
      try{
        const txt=await f.text();
        const obj=JSON.parse(txt);
        for(const k of Object.keys(obj)){
          if(!dataset[k])dataset[k]=[];
          dataset[k]=dataset[k].concat(obj[k]);
        }
        saveDataset(); alert('Imported!');
      }catch(err){alert('Invalid JSON');}
      e.target.value='';
    });

    refreshCounts();
    startCamera();
  </script>
</body>
</html>
